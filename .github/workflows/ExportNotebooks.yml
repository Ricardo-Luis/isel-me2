name: Export Pluto notebooks & Deploy
permissions:
    contents: write
on:
    push:
        branches:
            - main
    pull_request:
        branches:
            - main
    workflow_dispatch:
concurrency:
    group: export
    cancel-in-progress: true
jobs:
    build-and-deploy:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout Fall 23 source
              uses: actions/checkout@v4
              
            - name: ğŸ™Œ Install Julia
              uses: julia-actions/setup-julia@v2
              with:
                  version: "1"
                  
            - name: â± Cache notebook states
              uses: actions/cache@v4
              with:
                path: _cache
                key: ${{ runner.os }}-pluto_state_cache-v3-${{ hashFiles('**/Project.toml', '**/Manifest.toml') }}-${{ github.run_id }}
                restore-keys: |
                    ${{ runner.os }}-pluto_state_cache-v3-${{ hashFiles('**/Project.toml', '**/Manifest.toml') }}
                    
            - name: â± Cache .julia
              uses: actions/cache@v4
              with:
                path: ~/.julia
                key: ${{ runner.os }}-dotjulia-v1-${{ hashFiles('**/Project.toml', '**/Manifest.toml') }}-${{ github.run_id }}
                restore-keys: |
                    ${{ runner.os }}-dotjulia-v1-${{ hashFiles('**/Project.toml', '**/Manifest.toml') }}
                    
            - name: ğŸ”§ Setup Julia environment
              run: |
                echo "ğŸ” Verificando ambiente pluto-deployment-environment..."
                if [ -f "pluto-deployment-environment/Project.toml" ]; then
                  echo "âœ… Project.toml encontrado"
                  echo "ğŸ“„ ConteÃºdo do Project.toml:"
                  cat pluto-deployment-environment/Project.toml
                  echo ""
                  if [ -f "pluto-deployment-environment/Manifest.toml" ]; then
                    echo "ğŸ“„ Manifest.toml tambÃ©m existe"
                  else
                    echo "âš ï¸ Manifest.toml nÃ£o encontrado"
                  fi
                else
                  echo "âŒ Project.toml nÃ£o encontrado em pluto-deployment-environment/"
                fi
                
            - name: ğŸª´ Generate site
              run: |
                echo "ğŸ”§ Preparando estrutura para PlutoPages..."
                
                # Verificar estrutura atual
                echo "ğŸ“‚ Verificando estrutura da pasta content:"
                if [ -d "content" ]; then
                  find content -type f -name "*.jl" -o -name "*.jlmd" -o -name "*.md" | head -20
                else
                  echo "âŒ Pasta content nÃ£o encontrada"
                  exit 1
                fi
                
                # Criar symbolic link de content para src (PlutoPages espera pasta src)
                echo "ğŸ”— Criando link simbÃ³lico de content para src..."
                ln -sf content src
                
                # Verificar se o link foi criado
                echo "âœ… Link criado, verificando:"
                ls -la src/
                
                julia --project=pluto-deployment-environment -e '
                  import Pkg;
                  println("ğŸ” Ambiente ativo: ", Pkg.project().path);
                  Pkg.instantiate();
                  
                  # Verificar se PlutoPages estÃ¡ disponÃ­vel
                  if haskey(Pkg.project().dependencies, "PlutoPages")
                    println("âœ… PlutoPages encontrado nas dependÃªncias");
                  else
                    println("âš ï¸ PlutoPages nÃ£o estÃ¡ nas dependÃªncias, adicionando...");
                    Pkg.add("PlutoPages");
                  end
                  
                  println("ğŸš€ Importando PlutoPages...");
                  import PlutoPages;
                  println("âœ… PlutoPages importado com sucesso");
                  
                  println("ğŸ”§ Gerando site usando link simbÃ³lico para content...");
                  PlutoPages.generate("."; html_report_path="generation_report.html");
                  println("âœ… Site gerado com sucesso");
                '
                  
            - name: ğŸ“° Upload site generation report
              uses: actions/upload-artifact@v4
              if: always()
              with:
                name: generation-report
                path: generation_report.html
                
            - name: ğŸ” Debug - Check repository structure
              run: |
                echo "ğŸ“‚ Estrutura completa do repositÃ³rio:"
                find . -type f -name "*.jl" -o -name "*.md" | head -20
                echo ""
                echo "ğŸ“‚ Verificando pasta src:"
                if [ -d "src" ]; then
                  echo "âœ… Pasta src existe"
                  echo "ğŸ“„ ConteÃºdo da pasta src:"
                  ls -la src/
                  find src -type f | head -10
                else
                  echo "âŒ Pasta src nÃ£o existe"
                fi
                echo ""
                echo "ğŸ“‚ Procurando notebooks (.jl) em todo o repositÃ³rio:"
                find . -name "*.jl" -type f | head -10
                echo ""
                echo "ğŸ“‚ Estrutura geral (primeiros 20 itens):"
                ls -la | head -20
                
            - name: ğŸ”€ Combine semesters into single site
              run: |
                echo "ğŸ”§ Criando estrutura do site..."
                mkdir -p www
                
                # Verificar se _site existe e mover
                if [ -d "_site" ] && [ "$(ls -A _site)" ]; then
                  mv _site www/Fall23
                  echo "âœ… _site movido para www/Fall23"
                else
                  echo "âŒ _site nÃ£o encontrado ou vazio"
                  # Criar pasta vazia como fallback
                  mkdir -p www/Fall23
                  echo "<h1>Site em construÃ§Ã£o</h1>" > www/Fall23/index.html
                fi
                
                # Verificar se extra_outputs existe e mover
                if [ -d "extra_outputs" ] && [ "$(ls -A extra_outputs)" ]; then
                  mv extra_outputs/* www/
                  echo "âœ… extra_outputs movido para www/"
                else
                  echo "â„¹ï¸ extra_outputs nÃ£o encontrado ou vazio"
                fi
                
                # Criar index.html na raiz se nÃ£o existir
                if [ ! -f "www/index.html" ]; then
                  cat > www/index.html << 'EOF'
                <!DOCTYPE html>
                <html lang="en">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>Computational Thinking</title>
                    <meta http-equiv="refresh" content="0; url=./Fall23/">
                    <style>
                        body { 
                            font-family: Arial, sans-serif; 
                            text-align: center; 
                            padding: 50px; 
                            background-color: #f5f5f5;
                        }
                        .container {
                            max-width: 600px;
                            margin: 0 auto;
                            background: white;
                            padding: 40px;
                            border-radius: 10px;
                            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                        }
                        a { 
                            color: #007bff; 
                            text-decoration: none; 
                            font-weight: bold;
                        }
                        a:hover { text-decoration: underline; }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <h1>Computational Thinking</h1>
                        <p>A redirecionar para o conteÃºdo Fall 23...</p>
                        <p>Se nÃ£o for redirecionado automaticamente, <a href="./Fall23/">clique aqui</a>.</p>
                    </div>
                    <script>
                        setTimeout(function() {
                            window.location.href = './Fall23/';
                        }, 100);
                    </script>
                </body>
                </html>
                EOF
                  echo "âœ… index.html criado na raiz"
                fi
                
                echo "ğŸ“ Estrutura final do www:"
                find www -type f | sort
                
            - name: ğŸš€ Deploy to GitHub Pages (main)
              if: github.event_name == 'push' && github.ref == 'refs/heads/main'
              uses: actions/deploy-pages@v4
              with:
                token: ${{ secrets.GITHUB_TOKEN }}
                artifact_name: github-pages
                
            - name: ğŸ“¦ Upload Pages artifact
              if: github.event_name == 'push' && github.ref == 'refs/heads/main'
              uses: actions/upload-pages-artifact@v3
              with:
                path: www
    
            - name: Deploy PR preview
              if: github.event_name == 'pull_request' && github.repository == github.event.pull_request.head.repo.full_name
              uses: JamesIves/github-pages-deploy-action@v4
              with:
                token: ${{ secrets.GITHUB_TOKEN }}
                branch: output
                folder: www
                target-folder: "previews/PR${{ github.event.number }}"
