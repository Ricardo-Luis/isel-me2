name: Export Pluto notebooks & Deploy
permissions:
    contents: write
on:
    push:
        branches:
            - main
    workflow_dispatch:
concurrency:
    group: pluto-export
    cancel-in-progress: true
jobs:
    build-and-deploy:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout Fall 23 source
              uses: actions/checkout@v4
              
            - name: ğŸ™Œ Install Julia
              uses: julia-actions/setup-julia@v2
              with:
                  version: "1"  # Ãšltima versÃ£o automaticamente
                  
            - name: Cache Julia artifacts & such
              uses: julia-actions/cache@v2
              with:
                cache-registries: "true"
                
            # Cache para notebooks exportados - se o notebook nÃ£o mudou, usa cache
            - name: Set up notebook state cache
              uses: actions/cache@v4
              with:
                  path: pluto_state_cache
                  key: ${{ runner.os }}-pluto_state_cache-v2-${{ hashFiles('**/Project.toml', '**/Manifest.toml', '.github/workflows/*' ) }}-${{ hashFiles('**/*jl') }}
                  restore-keys: |
                      ${{ runner.os }}-pluto_state_cache-v2-${{ hashFiles('**/Project.toml', '**/Manifest.toml', '.github/workflows/*' ) }}
                      
            - name: Ignore notebook state cache in export
              run: echo 'pluto_state_cache' >> .gitignore
              
            - name: ğŸª´ Run & export Pluto notebooks
              run: |
                julia -e 'using Pkg
                  Pkg.activate(mktempdir())
                  Pkg.add([
                    Pkg.PackageSpec(name="PlutoSliderServer", version="1"),
                  ])
                  import PlutoSliderServer
                  PlutoSliderServer.github_action(".";
                    Export_cache_dir="pluto_state_cache",
                    Export_baked_notebookfile=false,
                    Export_baked_state=false,
                  )'
                  
            - name: ğŸ”€ Combine semesters into single site
              run: |
                echo "ğŸ”§ Organizando estrutura do site..."
                mkdir -p www
                
                # Mover ficheiros exportados para estrutura do site
                if [ -d "_site" ]; then
                  mv _site www/Fall23
                  echo "âœ… _site movido para www/Fall23"
                else
                  echo "âš ï¸ _site nÃ£o encontrado, procurando ficheiros HTML..."
                  mkdir -p www/Fall23
                  # Mover ficheiros HTML gerados
                  find . -name "*.html" -not -path "./www/*" -not -path "./_site/*" -not -path "./pluto_state_cache/*" | head -20 | while read file; do
                    echo "ğŸ“„ Movendo: $file"
                    cp "$file" www/Fall23/
                  done
                fi
                
                # Verificar se hÃ¡ outros outputs
                if [ -d "extra_outputs" ] && [ "$(ls -A extra_outputs)" ]; then
                  mv extra_outputs/* www/ 2>/dev/null || echo "âš ï¸ Erro ao mover extra_outputs"
                else
                  echo "â„¹ï¸ Sem extra_outputs"
                fi
                
                echo "ğŸ“ Estrutura final do site:"
                find www -type f | head -10
                
            - name: ğŸš€ Deploy to GitHub Pages
              uses: JamesIves/github-pages-deploy-action@v4
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}
                  branch: output  # MantÃ©m o seu branch 'output'
                  folder: www
                  single-commit: true
