name: Export Pluto notebooks & Deploy
permissions:
    contents: write
    pages: write
    id-token: write
on:
    push:
        branches:
            - main
    pull_request:
        branches:
            - main
    workflow_dispatch:
concurrency:
    group: pluto-export-${{ github.ref }}
    cancel-in-progress: true
jobs:
    build-and-deploy:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout Fall 23 source
              uses: actions/checkout@v4
              
            - name: üôå Install Julia
              uses: julia-actions/setup-julia@v2
              with:
                  version: "1"
                  
            - name: Cache Julia artifacts & such
              uses: julia-actions/cache@v2
              with:
                cache-registries: "true"
                
            - name: Set up notebook state cache
              uses: actions/cache@v4
              with:
                  path: pluto_state_cache
                  key: ${{ runner.os }}-pluto_state_cache-v2-${{ hashFiles('**/Project.toml', '**/Manifest.toml', '.github/workflows/*' ) }}-${{ hashFiles('**/*jl') }}
                  restore-keys: |
                      ${{ runner.os }}-pluto_state_cache-v2-${{ hashFiles('**/Project.toml', '**/Manifest.toml', '.github/workflows/*' ) }}
                      
            - name: Ignore notebook state cache in export
              run: echo 'pluto_state_cache' >> .gitignore
              
            - name: ü™¥ Run & export Pluto notebooks
              run: |
                julia -e 'using Pkg
                  Pkg.activate(mktempdir())
                  Pkg.add([
                    Pkg.PackageSpec(name="PlutoSliderServer", version="1"),
                  ])
                  import PlutoSliderServer
                  PlutoSliderServer.github_action(".";
                    Export_cache_dir="pluto_state_cache",
                    Export_baked_notebookfile=false,
                    Export_baked_state=false,
                  )'
                  
            - name: üîÄ Combine semesters into single site
              run: |
                echo "üîß Organizando estrutura do site..."
                mkdir -p www
                
                # Mover ficheiros exportados para estrutura do site
                if [ -d "_site" ]; then
                  mv _site www/Fall23
                  echo "‚úÖ _site movido para www/Fall23"
                else
                  echo "‚ö†Ô∏è _site n√£o encontrado, procurando ficheiros HTML..."
                  mkdir -p www/Fall23
                  # Mover ficheiros HTML gerados
                  find . -name "*.html" -not -path "./www/*" -not -path "./_site/*" -not -path "./pluto_state_cache/*" | head -20 | while read file; do
                    echo "üìÑ Movendo: $file"
                    cp "$file" www/Fall23/
                  done
                fi
                
                # Verificar se h√° outros outputs
                if [ -d "extra_outputs" ] && [ "$(ls -A extra_outputs)" ]; then
                  mv extra_outputs/* www/ 2>/dev/null || echo "‚ö†Ô∏è Erro ao mover extra_outputs"
                else
                  echo "‚ÑπÔ∏è Sem extra_outputs"
                fi
                
                echo "üìÅ Estrutura final do site:"
                find www -type f | head -10
                
            - name: üìù Create root index.html
              run: |
                cat > www/index.html << 'EOF'
                <!DOCTYPE html>
                <html lang="en">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>Computational Thinking</title>
                    <meta http-equiv="refresh" content="0; url=./Fall23/">
                    <style>
                        body { 
                            font-family: Arial, sans-serif; 
                            text-align: center; 
                            padding: 50px; 
                            background-color: #f5f5f5;
                        }
                        .container {
                            max-width: 600px;
                            margin: 0 auto;
                            background: white;
                            padding: 40px;
                            border-radius: 10px;
                            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                        }
                        a { 
                            color: #007bff; 
                            text-decoration: none; 
                            font-weight: bold;
                        }
                        a:hover { text-decoration: underline; }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <h1>Computational Thinking</h1>
                        <p>A redirecionar para o conte√∫do Fall 23...</p>
                        <p>Se n√£o for redirecionado automaticamente, <a href="./Fall23/">clique aqui</a>.</p>
                    </div>
                    <script>
                        setTimeout(function() {
                            window.location.href = './Fall23/';
                        }, 100);
                    </script>
                </body>
                </html>
                EOF
                echo "‚úÖ index.html criado na raiz com redirect para Fall23"
                
            - name: üîç Debug - List final structure
              run: |
                echo "üìÇ Estrutura completa do diret√≥rio www:"
                find www -type f | sort
                echo ""
                echo "üìÑ Conte√∫do do index.html:"
                head -20 www/index.html
                
            # Deploy principal para o branch main
            - name: üöÄ Deploy to GitHub Pages (Main)
              if: github.event_name == 'push' && github.ref == 'refs/heads/main'
              uses: JamesIves/github-pages-deploy-action@v4
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}
                  branch: output
                  folder: www
                  single-commit: true
                  clean: true
                  
            # Deploy de preview para PRs (mant√©m a funcionalidade original)
            - name: üîç Deploy PR preview
              if: github.event_name == 'pull_request' && github.repository == github.event.pull_request.head.repo.full_name
              uses: JamesIves/github-pages-deploy-action@v4
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}
                  branch: output
                  folder: www
                  target-folder: "previews/PR${{ github.event.number }}"
                  clean: false
